rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Users can only read/write their own data
    // Document structure: /users/{userId}
    // Fields: username, email, displayName, createdAt, updatedAt
    // Security: Only the authenticated user whose UID matches the document ID can access
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      // Encryption settings subcollection
      // Document structure: /users/{userId}/encryptionSettings/{settingsId}
      match /encryptionSettings/{settingsId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
      
      // Diff Checker settings subcollection
      // Document structure: /users/{userId}/diffCheckerSettings/{settingsId}
      match /diffCheckerSettings/{settingsId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
      
      // Time Zone Converter settings subcollection
      // Document structure: /users/{userId}/timezoneSettings/{settingsId}
      match /timezoneSettings/{settingsId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
      
      // Pickup Soccer settings subcollection
      // Document structure: /users/{userId}/pickupSoccerSettings/{settingsId}
      match /pickupSoccerSettings/{settingsId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
      
      // Secret Santa settings subcollection
      // Document structure: /users/{userId}/secretSantaSettings/{settingsId}
      match /secretSantaSettings/{settingsId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
      
      // Football Manager Team Picker settings subcollection
      // Document structure: /users/{userId}/footballManagerTeamPickerSettings/{settingsId}
      match /footballManagerTeamPickerSettings/{settingsId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
      
      // Football Manager Team Picker favorites subcollection
      // Document structure: /users/{userId}/footballManagerTeamPickerFavorites/{teamId}
      match /footballManagerTeamPickerFavorites/{teamId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
      
      // Football Manager Team Picker history subcollection
      // Document structure: /users/{userId}/footballManagerTeamPickerHistory/{historyId}
      match /footballManagerTeamPickerHistory/{historyId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
      
      // Color Palette Crafter settings subcollection
      // Document structure: /users/{userId}/colorPaletteCrafterSettings/{settingsId}
      match /colorPaletteCrafterSettings/{settingsId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
      
      // Color Palette Crafter favorites subcollection
      // Document structure: /users/{userId}/colorPaletteCrafterFavorites/{paletteId}
      match /colorPaletteCrafterFavorites/{paletteId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
      
      // Amer Gauntlet settings subcollection
      // Document structure: /users/{userId}/amerGauntletSettings/{settingsId}
      match /amerGauntletSettings/{settingsId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
      
      // Amer Gauntlet results subcollection
      // Document structure: /users/{userId}/amerGauntletResults/{date}
      match /amerGauntletResults/{date} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
      
      // Amer Gauntlet stats subcollection
      // Document structure: /users/{userId}/amerGauntletStats/{statsId}
      match /amerGauntletStats/{statsId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }
    
    // Color Palettes collection
    // Document structure: /colorPalettes/{paletteId}
    // Fields: colors[], title, description, likes, createdBy, createdByName, createdAt, updatedAt
    // Security: Anyone can read, only authenticated users can create, only creator can update/delete
    match /colorPalettes/{paletteId} {
      // Anyone can read palettes (browse public palettes)
      allow read: if true;
      
      // Only authenticated users can create palettes
      allow create: if request.auth != null && request.auth.uid == request.resource.data.createdBy;
      
      // Only the palette creator can delete
      allow delete: if request.auth != null && request.auth.uid == resource.data.createdBy;
      
      // Only the palette creator can update
      allow update: if request.auth != null && request.auth.uid == resource.data.createdBy;
    }
    
    // Pickup Soccer Games collection
    // Document structure: /games/{gameId}
    // Fields: title, description, date, time, location, maxPlayers, players[], createdBy, createdAt, updatedAt
    // Security: Anyone can read, only authenticated users can create, only creator can update/delete
    match /games/{gameId} {
      // Anyone can read games (view available games)
      allow read: if true;
      
      // Only authenticated users can create games
      allow create: if request.auth != null && request.auth.uid == request.resource.data.createdBy;
      
      // Only the game creator can delete
      allow delete: if request.auth != null && request.auth.uid == resource.data.createdBy;
      
      // Allow game creator to update any field
      allow update: if request.auth != null && request.auth.uid == resource.data.createdBy;
      
      // Allow any authenticated user to join/leave games (update players array only)
      // This allows users to add/remove themselves from the players array
      allow update: if request.auth != null && 
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['players', 'updatedAt']) &&
        request.resource.data.players is list &&
        resource.data.players is list;
    }
    
    // Secret Santa Exchanges collection
    // Document structure: /secretSantaExchanges/{exchangeId}
    // Fields: name, description, budget, exchangeDate, participants[], assignments{}, drawn, createdBy, createdByName, createdAt, updatedAt
    // Security: Anyone can read, only authenticated users can create, only creator can update/delete
    match /secretSantaExchanges/{exchangeId} {
      // Anyone can read exchanges (view available exchanges)
      allow read: if true;
      
      // Only authenticated users can create exchanges
      allow create: if request.auth != null && request.auth.uid == request.resource.data.createdBy;
      
      // Only the exchange creator can delete
      allow delete: if request.auth != null && request.auth.uid == resource.data.createdBy;
      
      // Allow exchange creator to update any field
      allow update: if request.auth != null && request.auth.uid == resource.data.createdBy;
      
      // Allow any authenticated user to join/leave exchanges (update participants array and their own responses)
      // This allows users to add/remove themselves from the participants array and update their own participantResponses
      allow update: if request.auth != null && 
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['participants', 'participantResponses', 'updatedAt']) &&
        request.resource.data.participants is list &&
        resource.data.participants is list &&
        // If participantResponses is being updated, ensure the user is joining (will be in new participants list)
        // and they're only adding/updating their own entry
        (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['participantResponses']) ||
         (request.auth.uid in request.resource.data.participants &&
          request.resource.data.participantResponses is map &&
          request.resource.data.participantResponses[request.auth.uid] is string));
    }
    
    // Amer Gauntlet Daily Leaderboard collection
    // Document structure: /amerGauntletDailyLeaderboard/{date_userId}
    // Fields: userId, displayName, date, score, attempts, time, word, createdAt
    // Security: Anyone can read, only authenticated users can create/update their own entries
    match /amerGauntletDailyLeaderboard/{entryId} {
      // Anyone can read leaderboard entries
      allow read: if true;
      
      // Only authenticated users can create entries for themselves
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
      
      // Only the user can update their own entry
      allow update: if request.auth != null && request.auth.uid == resource.data.userId;
      
      // Users can delete their own entries
      allow delete: if request.auth != null && request.auth.uid == resource.data.userId;
    }
    
    // Amer Gauntlet All-Time Leaderboard collection
    // Document structure: /amerGauntletAllTimeLeaderboard/{userId}
    // Fields: userId, displayName, totalScore, createdAt, updatedAt
    // Security: Anyone can read, only authenticated users can create/update their own entries
    match /amerGauntletAllTimeLeaderboard/{userId} {
      // Anyone can read leaderboard entries
      allow read: if true;
      
      // Only authenticated users can create entries for themselves
      allow create: if request.auth != null && request.auth.uid == userId;
      
      // Only the user can update their own entry
      allow update: if request.auth != null && request.auth.uid == userId;
      
      // Users can delete their own entries
      allow delete: if request.auth != null && request.auth.uid == userId;
    }
  }
}